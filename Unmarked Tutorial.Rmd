---
title: "Unmarked Tutorial"
author: "Wynne Moss"
date: "October 26, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("unmarked")
library(unmarked)
```

# Overview of Occupancy Framework

* Repeated measures sampling design

* J observations at M sampling units during T seasons

* Data can be counts of individuals

* MARK vs UNMARKED differ in that UNMARKED doesn't require any individual tagging or recognition

## Hierarchical models

* Observations are generated by:

    + *State process*: determines the abundance or occurrence at the site; models describe the abundance or occurrence at the site, but this can't be observed (latent variable)
    + *Detection process*: determines the observations conditional on the state process
    
## Capabilities of unmarked

* Single season site occupancy models
    + Probability that a site is occupied ($\psi$)
    + Observations Y~ij~ is whether species was detected in site i at time j.
    + *Key assumption*: the state at site i remains constant throughout the season.
    + Adding in co-variates
        - logit($\psi$~i~) = x~i~^T^($\beta$): predicts the probability of occupancy based on predictor variables
        - logit(p~ij~) = v~ij~^T^($\alpha$): predicts the probability of detection based on predictor variables
    + Function: `occu`

* Multi-season site occupancy model
    + To understand the dynamics of occupancy over time
    + Estimate colonization ($\gamma$) and extinction ($\epsilon$)
    + Described by a 2 state finite hidden Markov model (wtf)
    + Y~ijt~: observed species occurrence status at visit j during season t to site i
    + Model generalizes the single season model by relaxing assumption of closure. 
    + Transition probabilities between state are given by $\epsilon$ and $\gamma$
    + Function: `colext`
    + All four parameters: $\epsilon$, $\gamma$, $\psi$ and *p* can be modeled as functions of covariates
    
* Potential future models of interest: abundance models. Need repeated count data which could be tough.

# Using unmarked

## Data structure
* Data are stored in an `unmarkedFrame`. Different from a standard data structure (e.g. dataframe)
* Doesn't require that covariates are measured at both the site and visit level for example
* `csvToUMF` function converts data into an `unmarkedFrame`
* `formatWide` and `formatLong` convert data from dataframes
* Structure of the data
    + Components "slots" hold the data and metadata
    + One slot for the observation matrix y (observed counts or detection data) at each of M sites.
    + `siteCovs` is an M row dataframe with a column for each site-level covariate
    + `obsCovs` is an MJ row dataframe with a column for each observation-level covariate
    + Covariate dataframes can contain NAs corresponding to unbalanced data.


## Example: repeated count data
```{r}
data("mallard")
mallard.y[1:5,] # the observation data
# number of mallards at 239 sites on 3 visits
mallard.site[1:5,] # site level covariates (239 rows)
mallard.obs$ivel[1:5,] 
# observation level covariates; ivel is survey effort at each date
# (239 rows, 3 cols)
mallard.obs$date[1:5,]
# observation level covariates: date of each obs
# (239 rows, 3 cols)
mallardUMF <- unmarkedFramePCount(y = mallard.y, siteCovs = mallard.site, obsCovs = mallard.obs)
summary(mallardUMF)
```

## Preparing multi season occupancy data
```{r}
# M = 4 sites
# T = 2 seasons
# J = 3 visists per season
y = data.frame(
  "season1v1" = c(0,1,0,1),
  "season1v2" = c(0,1,0,1),
  "season1v3" = c(0,1,0,1),
  "season2v1" = c(0,1,0,1),
  "season2v2" = c(0,1,0,1),
  "season2v3" = c(0,1,0,1)
)
rownames(y) = c("site1", "site2", "site3", "site4")
umf <- unmarkedMultFrame(y=y, numPrimary=2)
```

## Fitting a repeated count model

Model detection probability by day of year including a quadratic term.
Model abundance by elevation and area of forest

Covariates of detection are on the logit-scale and covariates of abundance are on the log-scale.
```{r}
fm.mallard.1 <- pcount(~ date + I(date^2) ~ elev + forest,data = mallardUMF, K = 50)
fm.mallard.1
```

Interpretation: mallard abundance decreases with elevation and forest cover. 

Now, fit a linear detection model
```{r}
fm.mallard.2 <- pcount(~ date ~ elev + forest, data = mallardUMF,K = 50)
fm.mallard.2
```

Detection decreases throughout the year.
A better model fit.

## Examining fitted models
```{r}
coef(fm.mallard.2)
coef(fm.mallard.2, type = "state")
vcov(fm.mallard.2, type = "det")
```

Getting error via bootstrapping
```{r}
set.seed(1234)
fm.mallard.2 <- nonparboot(fm.mallard.2, B = 100)
SE(fm.mallard.2, type = "state")
```

Linear combinations of estimates

Find the log abundance for a site with given combination of variables; like predict
```{r}
# lc <- linearComb(fm.oven.1, type = "state", coefficients = matrix(c(1,.5,0,1,1,0), 2,3, byrow = TRUE))
# does multiple sets of coefficients. 
# SE(lc, method = "nonparboot")
```

Backtransform to get the probability between 0 and 1

```{r}
btlc <- backTransform(lc)
```

